# 네임 서버의 개념
## 네임 서버 개요
네임 서버 == DNS(Domain Name System)서버<br>
DNS 서버 : URL을 사용해 원하는 서버에 접근할 때 URL에 맞는 IP 주소로 변환 시켜줌
- hosts 파일<br>
/etc/hosts 로 존재하는 파일<br>
도메인네임과 IP주소를 매핑하여 저장해놓는 파일<br>
예) 실제 내 C:\Windows\System32\drivers\etc 에 있는 hosts 파일
![내꺼hosts파일](https://user-images.githubusercontent.com/92290312/193617050-595991e9-a11a-40e6-a2e4-53417fca5ece.png)
<br>

hosts 파일을 사용해 어느정도는 도메인과 IP주소를 매핑 시킬 수 있었으나 IP주소가 기하급수적으로 많아지는 문제와 IP의 변경에 따른 실시간 수정이 어렵기 때문에 <b>이름 해석(name resloution)</b>을 전문으로 하는 서버(네임서버)가 필요해짐<br>

### hosts 파일 설정과 네임서버 설정
1. 현재 PC가 사용하는 네임서버의 IP 정보를 확인<br>
nslookup 명령어 사용
```cli
[root@localhost ~]# nslookup
> server
Default server: 192.168.111.2
Address: 192.168.111.2#53
> www.nate.com
Server:		192.168.111.2
Address:	192.168.111.2#53

Non-authoritative answer:
Name:	www.nate.com
Address: 120.50.131.112
> www.kernel.org
Server:		192.168.111.2
Address:	192.168.111.2#53

Non-authoritative answer:
www.kernel.org	canonical name = geo.source.kernel.org.
geo.source.kernel.org	canonical name = sin.source.kernel.org.
Name:	sin.source.kernel.org
Address: 145.40.73.55
Name:	sin.source.kernel.org
Address: 2604:1380:40e1:4800::1
> www.sogang.ac.kr
Server:		192.168.111.2
Address:	192.168.111.2#53

Non-authoritative answer:
Name:	www.sogang.ac.kr
Address: 163.239.1.17
> exit
```
2. 네임 서버가 설정된 파일 확인<br>
cat /etc/resolv.conf
```cli
[root@localhost ~]# cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 192.168.111.2
```
3. /etc/resolv/conf 파일을열어 nameserver 부분을 주석처리한다.<br>
=> 네임 서버가 고장난 것처럼 만들어주는 거임<br>
(이 파일은 수정해도 상관없지만, 컴퓨터가 재부팅 되거나 네트워크가 재시작되면 /etc/sysconfig/network-scripts/ifcfg-ens160 파일에 설정된 내용으로 초기화됨)

```cli
[root@localhost ~]# gedit /etc/resolv.conf 
```
![nameserer 부분 주석](https://user-images.githubusercontent.com/92290312/193618632-173f5522-4579-48e8-8daa-01b7c9b5cc90.png)
<br>

4. 서강대학교 홈페이지를 들어가본다.<br>
![서강대 연결안됨](https://user-images.githubusercontent.com/92290312/193617598-178ca9fa-fcc0-4657-8d36-b14d15220383.png)
<br><br><br>
cli 환경에서는 elinks 패키지를 설치해서 확인하자(텍스트 기반 웹 브라우저)<br>
![elinks1](https://user-images.githubusercontent.com/92290312/193617693-8505572b-e101-45fc-ad9b-d3016fc7a96a.png)<br>
![elinks2](https://user-images.githubusercontent.com/92290312/193617712-bf00ade5-a200-4543-b31b-8fd1d3f6859b.png)<br>
![elinks3](https://user-images.githubusercontent.com/92290312/193617734-8e3fea2f-479e-4047-b8ff-0d0f38862a5f.png)<br>
이미지 출처 : https://www.dedoimedo.com/computers/elinks-text-browser-linux-rescue.html

5. 아까 찾아본 서강대 IP로 들어가본다.<br>
![서강대 IP로 연결됨](https://user-images.githubusercontent.com/92290312/193618915-fadb7b02-4470-4227-8194-33f5eb726e0f.png)<br>
네임서버를 거치지 않았기 때문에 들어갈 수 있음
6. /etc/hosts 파일을 열어 서강대 IP주소를 추가 한 후 저장해보자.<br>
![서강대 IP 추가](https://user-images.githubusercontent.com/92290312/193618711-4f3803e3-a73a-484c-af1e-5e218544f350.png)<br>

7. 서강대 URL로 들어가지는 것을 확인<br>
![서강대 url로 들어가짐](https://user-images.githubusercontent.com/92290312/193617919-98c0c7ee-0a56-4db9-b073-7a81f22d482b.png)<br>


만약 etc/hosts 파일에서 도메인 네임과 IP 주소를 실제와 다르게 설정하면 다른게 설정한 대로 들어가 짐<br>
예) 도메인은 네이버인데 IP가 서강대 홈페이지면 네이버 url을 쳤을때 서강대로 들어감

* IP 주소를 얻는 과정<br>
![ip주소얻는 과정](https://user-images.githubusercontent.com/92290312/193619612-b336e72f-865e-4ea9-a0fc-7d945d57c4af.png)<br>
이미지출처 : https://m.blog.naver.com/powerlinedd/221743403434?view=img_14

<br>

## 네임 서버 구축
### 도메인 이름 체계
인터넷이 너무 많이 늘어서 인터넷상의 컴퓨터를 관리하기 위해 트리구조의 도메인 이름 체계가 고안됨.<br>
ROOT 네임서버는 1단계 네임서버인 com, net, org, edu, kr .. 등을 관리<br>
1단계 네임서버는 2단계 네임서버인 naver, nate, goolge 등을 관리함<br>
도메인 앞에 붙는 www, mail 같은 것은 컴퓨터 혹은 서버를 의미함

### 로컬 네임 서버가 작동하는 순서
![로컬 네임 서버 작동순서](https://user-images.githubusercontent.com/92290312/193619683-580ad3de-efea-40f2-be99-b556674b7220.png)
<br>

### 캐싱 전용 네임 서버
캐싱 전용 네임 서버(Caching-only Nameserver) 는 URL의 IP 주소를 알려주는 네임서버

#### 직접 네임 서버 구축하기
1. 네임 서버와 관련도니 패키지를 설치<br>
dnf -y install bind bind-chroot
2. 캐싱 전용 네임 서버와 관련된 설정 파일인 /etc/named.conf 를 수정하고 저장
![named conf 수정1](https://user-images.githubusercontent.com/92290312/193619790-bc4b190e-9024-4352-8cfc-fecc5efe2522.png)<br>
![named conf 수정2](https://user-images.githubusercontent.com/92290312/193619830-ca9ebc91-dedc-4d46-92ef-c8f1ace4d510.png)<br>
3. 서비스를 작동(네임 서버의 서비스(== 데몬) 이름은 "named")<br>
systemctl restart named => 재시작<br>
systemctl enable named  => 네임 서버 상시 가동<br>
systemctl status named  => 네임서버 상태 확인<br>
```cli
[root@localhost ~]# systemctl restart named
[root@localhost ~]# systemctl enable named

Created symlink /etc/systemd/system/multi-user.target.wants/named.service → /usr/lib/systemd/system/named.service.

[root@localhost ~]# systemctl status named

● named.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named.service; enabled; vendor preset: disa>
   Active: active (running) since Mon 2022-10-03 22:41:25 KST; 52s ago
 Main PID: 3428 (named)
    Tasks: 4 (limit: 11376)
   Memory: 55.1M
   CGroup: /system.slice/named.service
           └─3428 /usr/sbin/named -u named -c /etc/named.conf

10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './D>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './N>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './D>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './N>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './D>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './N>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './D>
10월 03 22:41:25 localhost.localdomain named[3428]: network unreachable resolving './N>
10월 03 22:41:26 localhost.localdomain named[3428]: resolver priming query complete
10월 03 22:41:26 localhost.localdomain named[3428]: managed-keys-zone: Key 20326 for z>
```
4. firewall-config 명령을 통해 [방화벽 설정]을 실행<br>
[설정]에서 [영구적]을 선택한 후 [영역]에서 [public]이 선택된 상태로 오른쪽 [서비스] 탭 [dns]의 체크를 켜서 DNS서버를 열어줌.<br>
[옵션]-[Firewalld 다시 불러오기]를 선택해 설정을 적용<br>
![firewall-config 설정](https://user-images.githubusercontent.com/92290312/193620010-730417cd-2668-41a6-b045-72150b2ca905.png)
<br>
5. 네임서버가 잘 작동하는지 dig @네임서버IP 조회할URL 형식으로 확인<br>

![image](https://user-images.githubusercontent.com/92290312/193624690-b9740e3e-ff1d-4115-b8cb-750c8aab7fd8.png)<br>

6. nslookup 명령을 사용한 확인<br>
```cli
[root@localhost ~]# nslookup 
> server 192.168.111.100
Default server: 192.168.111.100
Address: 192.168.111.100#53
> www.nate.com
Server:		192.168.111.100
Address:	192.168.111.100#53

Non-authoritative answer:
Name:	www.nate.com
Address: 120.50.131.112
```
7. 내 로컬 pc에서 확인<br>
```cli
C:\Users\minja>nslookup
기본 서버:  bns1.hananet.net
Address:  210.220.163.82

> server 192.168.111.100
기본 서버:  [192.168.111.100]
Address:  192.168.111.100

> www.nate.com
서버:    [192.168.111.100]
Address:  192.168.111.100

권한 없는 응답:
이름:    www.nate.com
Address:  120.50.131.112
```
8. 네임서버를 설정하는 방법<br>
su -c 'gedit /etc/resolv.conf' => root 권한으로 resolv.conf 파일을 수정<br>
![네임서버 IP설정](https://user-images.githubusercontent.com/92290312/193620238-f89cf216-d3e6-41ed-92a6-e3199b85d82e.png)
<br>

### 마스터 네임 서버
마스터 네임 서버 == 도메인에 속해 있는 컴퓨터들의 이름을 관리하고, 외부에서 컴퓨터 IP 주소를 요청하면 해당 IP주소를 알려주는 네임서버<br>
![마스터네임서버](https://user-images.githubusercontent.com/92290312/193620487-dbd8ace5-24e0-4593-8ef5-6301afb9bc5f.png)
<br><br>
* 마스터 네임서버 구축만 보자
1. /etc/named.conf 를 수정(아래와 같이 추가)<br>
![named conf 설정](https://user-images.githubusercontent.com/92290312/193620605-db53547e-7b75-41c2-8839-8a14442f9841.png)
<br>
2. 문법상 틀리지 않았는지 확인(오류 메시지가 없으면 틀린 것 없다는 뜻)<br>
```cli
[root@localhost ~]# named-checkconf 
```
3. /var/named 디렉터리로 이동 후 john.com.db 파일 생성(이 파일을 포워드 존 파일 또는 정방향 영역 파일이라고 함)<br>
```cli
[root@localhost ~]# cd /var/named/
[root@localhost named]# touch john.com.db
[root@localhost named]# ls
chroot  dynamic      named.ca     named.localhost  slaves
data    john.com.db  named.empty  named.loopback
```
4. john.com.db 를 열어 다음과 같이 수정<br>
![포워드 존 파일 수정](https://user-images.githubusercontent.com/92290312/193621116-d7561638-663b-4f57-b0d2-534713bbacd9.png)
<br>

* 포워드 존 파일 의미<br>

| 기호 | 의미 |
| :---: | :---: |
| $TTL | Time To Live 의 약자. <br>요청해간 IP주소를 캐시에 저장하는 시간 |
| ; | 주석 |
| @ | /etc/named.conf에 정의된 john.com을 의미 |
| IN | 클래스 이름. internet을 의미 |
| SOA | Start Of Authority 의 약자. <br>권한 시작을 의미.<br>차례대로 serial(버전 정보)<br>refresh(상위 네임 서버에 업데이트된 정보를 요청하는 간격)<br>retry(상위 네임 서버에 문제가 발생했을 때 재접속 간격)<br>expire(상위 네임 서버에 접속하지 못할 경우 이전 정보를 파기하는 간격)<br>minimum(이 시간 이후 정보가 삭제됨)|
| NS | Name Server. 설정된 도메인의 네임서버 역할을 하는 컴퓨터를 지정 |
| MX | Mail Excanger. 메일 서버 컴퓨터를 설정 |
| A | 호스트 이름에 상응하는 IP 주소를 지정 |
| CNAME | 호스트 이름에 별칭을 부여할 때 사용 |

5. 문법상 이상이 없는지 확인<br>
named-checkzone  도메인이름 설정파일이름
```cli
[root@localhost named]# named-checkzone  john.com john.com.db 
zone john.com/IN: loaded serial 2
OK
```
6. 설정 내용을 적용.(네임서비스 재시작 후 확인)<br>
```cli
[root@localhost named]# systemctl restart named
[root@localhost named]# systemctl status named
● named.service - Berkeley Internet Name Domain (DNS)
   Loaded: loaded (/usr/lib/systemd/system/named.service; enabled; vendor preset: disa>
   Active: active (running) since Tue 2022-10-04 00:06:28 KST; 11s ago
  Process: 4818 ExecStop=/bin/sh -c /usr/sbin/rndc stop > /dev/null 2>&1 || /bin/kill >
  Process: 4833 ExecStart=/usr/sbin/named -u named -c ${NAMEDCONF} $OPTIONS (code=exit>
  Process: 4830 ExecStartPre=/bin/bash -c if [ ! "$DISABLE_ZONE_CHECKING" == "yes" ]; >
 Main PID: 4835 (named)
    Tasks: 4 (limit: 11376)
   Memory: 54.3M
   CGroup: /system.slice/named.service
           └─4835 /usr/sbin/named -u named -c /etc/named.conf

10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './D>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './N>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './D>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './N>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './D>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './N>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './D>
10월 04 00:06:28 localhost.localdomain named[4835]: network unreachable resolving './N>
10월 04 00:06:29 localhost.localdomain named[4835]: resolver priming query complete
10월 04 00:06:29 localhost.localdomain named[4835]: managed-keys-zone: Key 20326 for z>
```
7. firewall-config 명령을 동해 [설정]-[영구정] 및 서비스탭의 [dns] 체크
8. 이제 192.168.111.200 의 서버에서 /etc/resolv.conf 의 네임서버가 192.168.111.100 으로 되어있으면 된다.
<br><br>

### 라운드 로빈 방식의 네임 서버
서버를 여러대를 운영할 때 클라이언트가 서비스를 요청할 경우 교대로 서비스를 실행하여 웹 서버의 부하를 여러대가 공평하게 나누는 방식을 라운드로빈(Round robin) 방식이라고 함.

* 구축 방법
1. /var/named/john.com/db 파일을 다음 그림을 참고하여 수정<br>
![라운드로빈방식](https://user-images.githubusercontent.com/92290312/193621283-7a8ee2c9-401a-41d5-82ac-caa7f4ecc5d3.png)
<br>
2. 변경사항을 적용<br>
systemctl restart named

3. nslookup을 통해 정보를 확인<br>

```cli
[root@localhost named]# gedit /var/named/john.com.db 
[root@localhost named]# systemctl restart named
[root@localhost named]# nslookup 
> server 192.168.111.100
Default server: 192.168.111.100
Address: 192.168.111.100#53
> www.john.com
Server:		192.168.111.100
Address:	192.168.111.100#53

www.john.com	canonical name = webserver.john.com.
Name:	webserver.john.com
Address: 120.50.131.112
Name:	webserver.john.com
Address: 119.205.194.11
Name:	webserver.john.com
Address: 218.38.58.195
```
<br>
- 역방향 영역이란?<br>
IP주소를 통해서 도메인을 알아내는 영역<br>
리버스 존(Reverse Zone) 이라고도 함.
